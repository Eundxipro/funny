<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirim Cerita Anda - Kisah Kampus Kita</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px; margin: 0; }
        .container { background-color: #ffffff; padding: 32px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); width: 100%; max-width: 800px; text-align: center; }
        .hidden { display: none !important; }
        .topic-card { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease-in-out; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; }
        .topic-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); border-color: #3b82f6; }
        .card-icon-container { font-size: 2.5rem; color: #3b82f6; margin-bottom: 16px; width: 60px; height: 60px; background-color: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .card-title { font-size: 1.25rem; font-weight: 600; color: #111827; }
        #topicGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; }
        .form-label { display: block; text-align: left; font-weight: 600; margin-bottom: 8px; color: #374151; }
        .form-input, .form-textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #dbeafe; outline: none; }
        .form-textarea { min-height: 150px; resize: vertical; }
        .btn { color: white; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: #3b82f6; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-gemini { background: linear-gradient(to right, #4f46e5, #818cf8); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .file-upload-note { text-align: left; font-size: 0.8rem; color: #6b7280; margin-top: 8px; background-color: #f9fafb; padding: 8px; border-radius: 6px;}
        .screen { animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Modal for Loading/Success -->
        <div id="statusModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div id="loader" class="loader"></div>
                <p id="modalText" class="font-semibold text-lg"></p>
            </div>
        </div>

        <!-- Screen 1: Topic Selection -->
        <div id="topicSelectionScreen" class="screen">
            <h1 class="text-3xl font-bold mb-2 text-gray-800">Update Kisah yang Kamu Miliki</h1>
            <p class="text-gray-600 mb-8">Pilih kategori topik untuk ceritamu.</p>
            <div id="topicGrid"></div>
             <a href="index.html" class="btn btn-secondary mt-8"><i class="fas fa-arrow-left"></i> Kembali ke Halaman Utama</a>
        </div>

        <!-- Screen 2: Submission Form -->
        <div id="formScreen" class="hidden screen">
            <h2 id="formTitle" class="text-2xl font-bold mb-6 text-left text-blue-600"></h2>
            <form id="submissionForm">
                <div class="mb-4">
                    <label for="imageUpload" class="form-label">Gambar Pendukung</label>
                    <input type="file" id="imageUpload" name="imageUpload" class="form-input" accept="image/png, image/jpeg">
                    <p class="file-upload-note"><b>Catatan:</b> Anda hanya perlu memilih file gambar. Admin akan mengunggahnya nanti. Cukup pastikan nama file-nya unik.</p>
                </div>
                <div class="mb-4">
                    <label for="narrative" class="form-label">Ketik Ceritamu Disini</label>
                    <textarea id="narrative" name="narrative" class="form-textarea" placeholder="Tuliskan kata kunci, poin-poin, atau draf kasar ceritamu..." required></textarea>
                </div>
                <div class="text-left mb-6">
                    <button type="button" id="geminiBtn" class="btn btn-gemini">
                        <i class="fas fa-magic"></i> Buat Lebih Menarik dengan AI
                    </button>
                </div>
                <div class="flex justify-between items-center">
                    <button type="button" id="backToSelectionBtn" class="btn btn-secondary"><i class="fas fa-chevron-left"></i> Ganti Topik</button>
                    <button type="submit" id="submitBtn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Kirim Cerita
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
         apiKey: "AIzaSyA_lcZ-_2eDPcZ44efVhRRcOkJQamO4S5E",
         authDomain: "funny-e436a.firebaseapp.com",
         projectId: "funny-e436a",
         storageBucket: "funny-e436a.firebasestorage.app",
         messagingSenderId: "626813764903",
         appId: "1:626813764903:web:73250f741ddaac3a555502",
         measurementId: "G-MSSK2DD3SD"
        };
        
        let app, db, auth;
        let selectedTopic = null;
        const appId = firebaseConfig.appId;
        
        // --- ELEMEN UI ---
        const topicSelectionScreen = document.getElementById('topicSelectionScreen');
        const formScreen = document.getElementById('formScreen');
        const topicGrid = document.getElementById('topicGrid');
        const formTitle = document.getElementById('formTitle');
        const submissionForm = document.getElementById('submissionForm');
        const narrativeInput = document.getElementById('narrative');
        const imageInput = document.getElementById('imageUpload');
        const geminiBtn = document.getElementById('geminiBtn');
        const backToSelectionBtn = document.getElementById('backToSelectionBtn');
        const statusModal = document.getElementById('statusModal');
        const modalText = document.getElementById('modalText');
        const loader = document.getElementById('loader');

        const topics = [
            { key: "romansa", name: "Romansa Kampus", icon: "fas fa-heartbeat" },
            { key: "anomali", name: "Anomali Mahasiswa", icon: "fas fa-ghost" },
            { key: "gamer", name: "Arena Gamer", icon: "fas fa-headset" },
            { key: "tugas", name: "Pejuang Deadline", icon: "fas fa-hourglass-half" },
            { key: "fyi", name: "FYI Kampus", icon: "fas fa-info-circle" }
        ];
        
        // --- FUNGSI MODAL ---
        function showModal(text, showLoader = true) {
            modalText.textContent = text;
            loader.style.display = showLoader ? 'block' : 'none';
            statusModal.classList.remove('hidden');
        }

        function hideModal() {
            statusModal.classList.add('hidden');
        }

        // --- INISIALISASI ---
        function initializeTopicSelection() {
            topicGrid.innerHTML = '';
            topics.forEach(topic => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.dataset.key = topic.key;
                card.dataset.name = topic.name;
                card.innerHTML = `
                    <div class="card-icon-container"><i class="${topic.icon}"></i></div>
                    <h3 class="card-title">${topic.name}</h3>
                `;
                card.addEventListener('click', () => {
                    selectedTopic = { key: card.dataset.key, name: card.dataset.name };
                    formTitle.textContent = `Kirim Cerita untuk: ${selectedTopic.name}`;
                    topicSelectionScreen.classList.add('hidden');
                    formScreen.classList.remove('hidden');
                });
                topicGrid.appendChild(card);
            });
        }

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                console.log("Firebase ready for submission.");
            } catch (e) {
                console.error("Firebase init error:", e);
                geminiBtn.disabled = true;
                document.getElementById('submitBtn').disabled = true;
                alert("Tidak dapat terhubung ke server. Fitur pengiriman dinonaktifkan.");
            }
        }

        // --- LOGIKA UTAMA ---
        backToSelectionBtn.addEventListener('click', () => {
            formScreen.classList.add('hidden');
            topicSelectionScreen.classList.remove('hidden');
            submissionForm.reset();
            selectedTopic = null;
        });

        geminiBtn.addEventListener('click', async () => {
            const userText = narrativeInput.value.trim();
            if (userText.length < 10) {
                alert("Tuliskan setidaknya 10 karakter untuk dibantu oleh AI.");
                return;
            }
            
            showModal("AI sedang merangkai cerita...");
            geminiBtn.disabled = true;

            const prompt = `Sebagai seorang penulis konten viral untuk website "Kisah Kampus", ubah teks berikut menjadi narasi yang lebih menarik, dramatis, dan lucu dengan gaya bahasa anak muda. Pertahankan ide pokok dari teks asli. Teks asli: "${userText}"`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    narrativeInput.value = result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Respons AI tidak valid.");
                }
                hideModal();
            } catch (error) {
                console.error('Gemini API error:', error);
                modalText.textContent = 'Gagal menghubungi AI. Silakan coba lagi.';
                loader.style.display = 'none';
                setTimeout(hideModal, 2000);
            } finally {
                geminiBtn.disabled = false;
            }
        });
        
        submissionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedTopic || !db) {
                alert("Terjadi kesalahan. Silakan pilih topik lagi.");
                return;
            }

            const imageFile = imageInput.files[0];
            const narrativeText = narrativeInput.value.trim();

            if (!narrativeText) {
                alert("Mohon isi narasi cerita Anda.");
                return;
            }
            
            showModal("Mengirim ceritamu...");
            
            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/submissions`), {
                    topicKey: selectedTopic.key,
                    topicName: selectedTopic.name,
                    narrative: narrativeText,
                    imageFileName: imageFile ? imageFile.name : 'Tidak ada gambar',
                    status: 'pending_review',
                    submittedAt: serverTimestamp()
                });

                modalText.textContent = 'Cerita berhasil dikirim!';
                loader.style.display = 'none';
                setTimeout(() => {
                    hideModal();
                    backToSelectionBtn.click(); // Kembali ke pemilihan topik
                }, 2000);

            } catch (error) {
                console.error("Firestore submission error:", error);
                modalText.textContent = 'Gagal mengirim cerita.';
                loader.style.display = 'none';
                setTimeout(hideModal, 2000);
            }
        });

        // --- EKSEKUSI SAAT HALAMAN DIMUAT ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTopicSelection();
            initializeFirebase();
        });

    </script>
</body>
</html>
